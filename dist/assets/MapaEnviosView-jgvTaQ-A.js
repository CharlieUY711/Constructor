import{r as g,j as e,C as M,T as B,P as L,R as O}from"./index-CBzyT8Xh.js";import{O as E}from"./OrangeHeader-BlU9RVka.js";import{p as P,a as W}from"./info-tCLo8W3J.js";import{G}from"./GoogleMap-ByGhDAmT.js";import{N as j}from"./navigation-C9w3F0Dn.js";import{L as H}from"./loader-circle-I_QXHKop.js";import{C as N}from"./circle-check-Cnbp5T1u.js";import"./ConnectionStatusIcon-DNK7XK6P.js";import"./index-yKjPlrCh.js";import"./zap-DfkAaHqc.js";import"./lightbulb-CBYVe5_3.js";import"./map-pin-DghKX46y.js";import"./loader-CAj64nxW.js";const U=`https://${P}.supabase.co/functions/v1/api/mapa-envios`,V={"Content-Type":"application/json",Authorization:`Bearer ${W}`};async function Z(h,p){let m=U;const r=new URLSearchParams;r.toString()&&(m+=`?${r.toString()}`);const u=await(await fetch(m,{headers:V})).json();if(u.error)throw new Error(u.error);return u.data||[]}const c="#FF6835",S={lat:-34.9011,lng:-56.1645},K=12,d={deposito:{color:"#374151",label:"Depósito",icon:L,size:18},en_transito:{color:"#7C3AED",label:"En tránsito",icon:B,size:14},en_reparto:{color:c,label:"En reparto",icon:j,size:14},entregado:{color:"#059669",label:"Entregado",icon:N,size:13},fallido:{color:"#DC2626",label:"Fallido",icon:M,size:14}};function ae({onNavigate:h}){const[p,m]=g.useState("todos"),[r,x]=g.useState(null),[u,$]=g.useState([]),[I,k]=g.useState(!1),[w,z]=g.useState(null);g.useEffect(()=>{v()},[]);const v=async()=>{k(!0),z(null);try{const l=(await Z()).map(t=>({id:t.id,tipo:t.tipo,numero:t.numero||"",lat:t.lat||(t.x?void 0:S.lat),lng:t.lng||(t.y?void 0:S.lng),x:t.x,y:t.y,cliente:t.cliente||"",carrier:t.carrier||"",localidad:t.localidad||"",provincia:t.provincia||""}));$(l)}catch(o){z(o instanceof Error?o.message:"Error cargando datos"),console.error("Error cargando mapa de envíos:",o)}finally{k(!1)}},n=u,s={en_transito:n.filter(o=>o.tipo==="en_transito").length,en_reparto:n.filter(o=>o.tipo==="en_reparto").length,entregado:n.filter(o=>o.tipo==="entregado").length,fallido:n.filter(o=>o.tipo==="fallido").length};return I?e.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsx(E,{icon:j,title:"Mapa de Envíos",subtitle:"Cargando...",actions:[{label:"← Logística",onClick:()=>h("logistica")}]}),e.jsx("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(H,{size:32,color:c,style:{animation:"spin 1s linear infinite"}})})]}):w?e.jsx("div",{style:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:e.jsx(E,{icon:j,title:"Mapa de Envíos",subtitle:`Error: ${w}`,actions:[{label:"← Logística",onClick:()=>h("logistica")},{label:"↻ Reintentar",primary:!0,onClick:v}]})}):e.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsx(E,{icon:j,title:"Mapa de Envíos",subtitle:`${s.en_transito} en tránsito · ${s.en_reparto} en reparto · ${s.entregado} entregados · ${s.fallido} fallidos`,actions:[{label:"← Logística",onClick:()=>h("logistica")},{label:"↻ Actualizar",onClick:v}]}),e.jsxs("div",{style:{flex:1,display:"flex",overflow:"hidden",backgroundColor:"#F8F9FA"},children:[e.jsxs("div",{style:{width:"260px",flexShrink:0,backgroundColor:"#fff",borderRight:"1px solid #E5E7EB",display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"14px 16px",borderBottom:"1px solid #E5E7EB"},children:[e.jsx("p",{style:{margin:"0 0 10px",fontSize:"11px",fontWeight:700,color:"#374151",textTransform:"uppercase",letterSpacing:"0.06em"},children:"Filtrar por estado"}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"6px"},children:[{id:"todos",label:"Todos los envíos",count:n.filter(o=>o.tipo!=="deposito").length},{id:"en_transito",label:"En tránsito",count:s.en_transito},{id:"en_reparto",label:"En reparto",count:s.en_reparto},{id:"entregado",label:"Entregados",count:s.entregado},{id:"fallido",label:"Fallidos",count:s.fallido}].map(o=>{const l=o.id!=="todos"?d[o.id]:{color:"#374151"},t=p===o.id;return e.jsxs("button",{onClick:()=>m(o.id),style:{display:"flex",alignItems:"center",gap:"8px",padding:"8px 10px",border:`1px solid ${t?l.color:"#E5E7EB"}`,borderRadius:"8px",backgroundColor:t?`${l.color}12`:"#fff",cursor:"pointer",transition:"all 0.15s"},children:[e.jsx("div",{style:{width:"10px",height:"10px",borderRadius:"50%",backgroundColor:l.color,flexShrink:0}}),e.jsx("span",{style:{fontSize:"12px",fontWeight:t?700:500,color:t?l.color:"#374151",flex:1,textAlign:"left"},children:o.label}),e.jsx("span",{style:{fontSize:"11px",fontWeight:700,color:"#6B7280",backgroundColor:"#F3F4F6",padding:"1px 6px",borderRadius:"8px"},children:o.count})]},o.id)})})]}),e.jsxs("div",{style:{padding:"14px 16px",borderBottom:"1px solid #E5E7EB"},children:[e.jsx("p",{style:{margin:"0 0 10px",fontSize:"11px",fontWeight:700,color:"#374151",textTransform:"uppercase",letterSpacing:"0.06em"},children:"Leyenda"}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"6px"},children:[Object.entries(d).filter(([o])=>o!=="deposito").map(([o,l])=>{const t=l.icon;return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("div",{style:{width:"20px",height:"20px",borderRadius:"50%",backgroundColor:l.color,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:e.jsx(t,{size:10,color:"#fff"})}),e.jsx("span",{style:{fontSize:"12px",color:"#374151"},children:l.label})]},o)}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("div",{style:{width:"20px",height:"20px",borderRadius:"50%",backgroundColor:"#374151",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:e.jsx(L,{size:10,color:"#fff"})}),e.jsx("span",{style:{fontSize:"12px",color:"#374151"},children:"Depósito / origen"})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginTop:"4px"},children:[e.jsx("div",{style:{width:"10px",height:"10px",borderRadius:"50%",backgroundColor:c,boxShadow:`0 0 0 4px ${c}30`,flexShrink:0,marginLeft:"5px"}}),e.jsx("span",{style:{fontSize:"11px",color:"#9CA3AF",marginLeft:"5px"},children:"Pulso = en reparto activo"})]})]})]}),e.jsx("div",{style:{flex:1,overflowY:"auto",padding:"8px 0"},children:n.filter(o=>o.tipo!=="deposito"&&(p==="todos"||o.tipo===p)).map(o=>{const l=d[o.tipo],t=(r==null?void 0:r.id)===o.id;return e.jsxs("div",{onClick:()=>x(t?null:o),style:{display:"flex",gap:"10px",alignItems:"center",padding:"10px 16px",cursor:"pointer",backgroundColor:t?"#FFF4EC":"transparent",borderLeft:t?`3px solid ${c}`:"3px solid transparent"},children:[e.jsx("div",{style:{width:"26px",height:"26px",borderRadius:"50%",backgroundColor:l.color,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:e.jsx(l.icon,{size:11,color:"#fff"})}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:"11px",fontWeight:700,color:"#111",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:o.numero}),e.jsxs("div",{style:{fontSize:"10px",color:"#9CA3AF"},children:[o.localidad," · ",o.carrier]})]})]},o.id)})})]}),e.jsxs("div",{style:{flex:1,position:"relative",overflow:"hidden"},children:[(()=>{const l=n.filter(i=>i.tipo!=="deposito"&&(p==="todos"||i.tipo===p)&&i.lat!==void 0&&i.lng!==void 0).map(i=>{const a=d[i.tipo];return{id:i.id,lat:i.lat,lng:i.lng,title:`${i.numero} - ${a.label}`,color:a.color,onClick:()=>x(i)}});n.filter(i=>i.tipo==="deposito"&&i.lat!==void 0&&i.lng!==void 0).forEach(i=>{l.push({id:i.id,lat:i.lat,lng:i.lng,title:`Depósito ${i.numero}`,color:"#374151",onClick:()=>x(i)})});let F=S,f=K;if(l.length>0){const i=l.map(C=>C.lat),a=l.map(C=>C.lng),y=Math.min(...i),A=Math.max(...i),D=Math.min(...a),R=Math.max(...a);F={lat:(y+A)/2,lng:(D+R)/2};const T=A-y,_=R-D,b=Math.max(T,_);b>.5?f=10:b>.2?f=11:b>.1?f=12:b>.05?f=13:f=14}return e.jsx(G,{center:F,zoom:f,markers:l,height:"100%",onMarkerClick:i=>{const a=n.find(y=>y.id===i.id);a&&x(a)}})})(),r&&r.tipo!=="deposito"&&e.jsxs("div",{style:{position:"absolute",bottom:"20px",right:"20px",backgroundColor:"#fff",borderRadius:"12px",border:"1px solid #E5E7EB",padding:"16px",width:"240px",boxShadow:"0 4px 20px rgba(0,0,0,0.12)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"10px"},children:[e.jsx("div",{style:{width:"28px",height:"28px",borderRadius:"50%",backgroundColor:d[r.tipo].color,display:"flex",alignItems:"center",justifyContent:"center"},children:O.createElement(d[r.tipo].icon,{size:13,color:"#fff"})}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"12px",fontWeight:700,color:"#111"},children:r.numero}),e.jsx("div",{style:{fontSize:"10px",color:"#9CA3AF"},children:d[r.tipo].label})]}),e.jsx("button",{onClick:()=>x(null),style:{marginLeft:"auto",border:"none",background:"none",cursor:"pointer",color:"#9CA3AF",fontSize:"16px",lineHeight:1},children:"×"})]}),[["Cliente",r.cliente],["Carrier",r.carrier],["Localidad",r.localidad],["Provincia",r.provincia]].map(([o,l])=>e.jsxs("div",{style:{display:"flex",gap:"8px",fontSize:"11px",marginBottom:"5px"},children:[e.jsx("span",{style:{color:"#9CA3AF",width:"65px",flexShrink:0},children:o}),e.jsx("span",{style:{color:"#111",fontWeight:500},children:l})]},o)),e.jsx("button",{onClick:()=>h("envios"),style:{marginTop:"10px",width:"100%",padding:"8px",border:`1.5px solid ${c}`,borderRadius:"8px",backgroundColor:"transparent",color:c,fontSize:"12px",fontWeight:700,cursor:"pointer"},children:"Ver detalle del envío →"})]}),e.jsx("div",{style:{position:"absolute",top:"16px",right:"16px",display:"flex",flexDirection:"column",gap:"6px"},children:Object.entries(s).map(([o,l])=>{if(l===0)return null;const t=d[o];return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"6px",backgroundColor:"rgba(255,255,255,0.92)",padding:"5px 10px",borderRadius:"20px",boxShadow:"0 2px 8px rgba(0,0,0,0.1)",border:`1px solid ${t.color}30`},children:[e.jsx("div",{style:{width:"8px",height:"8px",borderRadius:"50%",backgroundColor:t.color}}),e.jsx("span",{style:{fontSize:"11px",fontWeight:700,color:t.color},children:l}),e.jsx("span",{style:{fontSize:"11px",color:"#374151"},children:t.label})]},o)})})]})]})]})}export{ae as MapaEnviosView};
