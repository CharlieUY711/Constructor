import{r as u,t as T,j as e,T as $,P as _,f as X}from"./index-CBzyT8Xh.js";import{O as Q}from"./OrangeHeader-BlU9RVka.js";import{p as Z,a as L}from"./info-tCLo8W3J.js";import{L as ee}from"./loader-circle-I_QXHKop.js";import{N as O}from"./navigation-C9w3F0Dn.js";import{C as M}from"./circle-check-Cnbp5T1u.js";import{C as V}from"./circle-x-CC8iknNx.js";import{R as oe}from"./rotate-ccw-Db1WxQr5.js";import{M as re}from"./map-pin-DghKX46y.js";import{L as te}from"./layers-DJ6506zY.js";import{C as ne}from"./chevron-down-CssqrEvL.js";import{C as se}from"./chevron-right-D_C5YBAy.js";import{E as ie}from"./eye-DPnaTfdN.js";import"./ConnectionStatusIcon-DNK7XK6P.js";import"./index-yKjPlrCh.js";import"./zap-DfkAaHqc.js";import"./lightbulb-CBYVe5_3.js";const N=`https://${Z}.supabase.co/functions/v1/api/envios`,G={"Content-Type":"application/json",Authorization:`Bearer ${L}`,apikey:L};async function H(t){try{const n=`${N}${t}`;console.log(`[enviosApi] GET ${n}`);const s=await fetch(n,{headers:G});let r;const c=s.headers.get("content-type");if(c&&c.includes("application/json"))r=await s.json();else{const p=await s.text();return console.error(`[enviosApi] Respuesta no JSON: ${s.status} ${p}`),{ok:!1,error:`Error ${s.status}: ${p||"Respuesta inv√°lida"}`}}if(!s.ok){console.error(`[enviosApi] Error ${s.status}:`,r);let p=`Error ${s.status}: ${s.statusText||"Error en la petici√≥n"}`;return typeof r=="string"?p=r:r&&typeof r=="object"&&(typeof r.error=="string"?p=r.error:r.error&&typeof r.error=="object"?p=r.error.message||r.error.details||r.error.hint||JSON.stringify(r.error):r.message?p=r.message:r.details?p=r.details:Object.keys(r).length>0&&(p=JSON.stringify(r))),{ok:!1,error:p}}return{ok:!0,data:r}}catch(n){return console.error(`[enviosApi] Error en GET ${t}:`,n),n instanceof TypeError&&n.message.includes("fetch")?{ok:!1,error:"Error de conexi√≥n. Verifica tu conexi√≥n a internet o contacta al administrador."}:{ok:!1,error:n instanceof Error?n.message:"Error desconocido al cargar datos"}}}async function ae(t,n){try{const s=await fetch(`${N}${t}`,{method:"PUT",headers:G,body:JSON.stringify(n)}),r=await s.json();if(!s.ok){let c="Error en la petici√≥n";return typeof r.error=="string"?c=r.error:r.error&&typeof r.error=="object"?c=r.error.message||r.error.error||JSON.stringify(r.error):r.message&&(c=r.message),{ok:!1,error:c}}return{ok:!0,data:r}}catch(s){return console.error(`Envios API PUT ${t}:`,s),{ok:!1,error:s instanceof Error?s.message:"Error desconocido"}}}async function le(t){var c,p;const n=new URLSearchParams;t!=null&&t.pedido_madre_id&&n.append("pedido_madre_id",t.pedido_madre_id),t!=null&&t.estado&&n.append("estado",t.estado),t!=null&&t.carrier&&n.append("carrier",t.carrier),t!=null&&t.tramo&&n.append("tramo",t.tramo);const s=n.toString()?`?${n.toString()}`:"",r=await H(s);if(console.log("[enviosApi] getEnvios response:",{ok:r.ok,error:r.error,data:r.data}),!r.ok)throw console.error("[enviosApi] Error en getEnvios:",r.error),new Error(r.error||"Error cargando env√≠os");return r.data?(console.log("[enviosApi] getEnvios: env√≠os encontrados:",((c=r.data.envios)==null?void 0:c.length)||0,"eventos:",((p=r.data.eventos)==null?void 0:p.length)||0),{envios:r.data.envios||[],eventos:r.data.eventos||[]}):(console.warn("[enviosApi] getEnvios: res.data es null/undefined"),{envios:[],eventos:[]})}async function de(t){const n=await H(`/${t}`);return!n.ok||!n.data?null:n.data}async function ce(t,n){const s=await ae(`/${t}`,n);if(!s.ok||!s.data)throw new Error(s.error||"Error actualizando env√≠o");return s.data.envio}const b="#FF6835";function P(t,n=[]){const s=new Date(t.fecha_creacion),r=t.fecha_estimada||"",c=n.map(p=>{const j=new Date(p.fecha);return{fecha:j.toLocaleDateString("es-AR",{day:"2-digit",month:"2-digit"}),hora:j.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit"}),estado:p.estado,descripcion:p.descripcion,ubicacion:p.ubicacion||"Sistema"}});return{id:t.id,numero:t.numero,pedidoMadre:t.numero_pedido||t.pedido_madre_id||"",estado:t.estado,origen:t.origen,destino:t.destino,destinatario:t.destinatario,carrier:t.carrier,tramo:t.tramo,peso:Number(t.peso)||0,bultos:t.bultos||1,fechaCreacion:s.toISOString().split("T")[0],fechaEstimada:r,tracking:t.tracking,eventos:c,envioData:t,eventosData:n}}function pe(t){const n=new Map;return t.forEach(s=>{const r=s.pedidoMadre||"sin-pedido";n.has(r)||n.set(r,{numero:s.pedidoMadre||"Sin pedido",cliente:s.destinatario,envios:[],total:0});const c=n.get(r);c.envios.push(s),c.total+=0}),Array.from(n.entries()).map(([s,r])=>({id:s,...r}))}const k={creado:{label:"Creado",color:"#6B7280",bg:"#F3F4F6",icon:_},despachado:{label:"Despachado",color:"#2563EB",bg:"#EFF6FF",icon:$},en_transito:{label:"En tr√°nsito",color:"#7C3AED",bg:"#F5F3FF",icon:O},en_deposito:{label:"En dep√≥sito",color:"#D97706",bg:"#FFFBEB",icon:te},en_reparto:{label:"En reparto",color:"#FF6835",bg:"#FFF4EC",icon:re},entregado:{label:"Entregado",color:"#059669",bg:"#ECFDF5",icon:M},fallido:{label:"Fallido",color:"#DC2626",bg:"#FEF2F2",icon:V},devuelto:{label:"Devuelto",color:"#9CA3AF",bg:"#F9FAFB",icon:oe}},B={local:{label:"Local",color:"#059669"},intercity:{label:"Intercity",color:"#2563EB"},internacional:{label:"Internacional",color:"#7C3AED"},last_mile:{label:"Last Mile",color:"#D97706"}};function C({label:t,value:n,sub:s,color:r,icon:c}){return e.jsxs("div",{style:{backgroundColor:"#fff",borderRadius:"12px",border:"1px solid #E5E7EB",padding:"16px 20px",display:"flex",gap:"14px",alignItems:"center"},children:[e.jsx("div",{style:{width:"44px",height:"44px",borderRadius:"12px",backgroundColor:`${r}18`,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:e.jsx(c,{size:20,color:r})}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"22px",fontWeight:800,color:"#111",lineHeight:1},children:n}),e.jsx("div",{style:{fontSize:"12px",color:"#6B7280",marginTop:"3px"},children:t}),s&&e.jsx("div",{style:{fontSize:"11px",color:r,marginTop:"2px",fontWeight:600},children:s})]})]})}function R({estado:t}){const n=k[t],s=n.icon;return e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"5px",fontSize:"11px",fontWeight:700,padding:"3px 9px",borderRadius:"20px",backgroundColor:n.bg,color:n.color,whiteSpace:"nowrap"},children:[e.jsx(s,{size:11})," ",n.label]})}function ze({onNavigate:t}){const[n,s]=u.useState([]),[r,c]=u.useState(!0),[p,j]=u.useState(new Set),[l,w]=u.useState(null),[m,J]=u.useState(""),[y,U]=u.useState("todos"),[E,Y]=u.useState("todos"),[q,W]=u.useState(!1),F=u.useCallback(async()=>{try{c(!0),console.log("[EnviosView] Iniciando carga de env√≠os...");const o={};y!=="todos"&&(o.estado=y),E!=="todos"&&(o.tramo=E),console.log("[EnviosView] Filtros aplicados:",o);const{envios:i,eventos:d}=await le(o);console.log("[EnviosView] Datos recibidos:",{envios:i.length,eventos:d.length});const f=new Map;d.forEach(g=>{f.has(g.envio_id)||f.set(g.envio_id,[]),f.get(g.envio_id).push(g)}),console.log("[EnviosView] Eventos agrupados por env√≠o:",f.size);const x=i.map(g=>{const S=f.get(g.id)||[];return P(g,S)});console.log("[EnviosView] Env√≠os transformados:",x.length);const a=pe(x);console.log("[EnviosView] Pedidos agrupados:",a.length),s(a),j(g=>g.size===0&&a.length>0?new Set([a[0].id]):g)}catch(o){console.error("[EnviosView] Error cargando env√≠os:",o);let i="Error desconocido";o instanceof Error?i=o.message:typeof o=="object"&&o!==null?"message"in o&&typeof o.message=="string"?i=o.message:"error"in o&&typeof o.error=="string"?i=o.error:i="Error al cargar env√≠os. Por favor, intenta nuevamente.":i=String(o),T.error(`Error al cargar env√≠os: ${i}`),s([])}finally{c(!1)}},[y,E]);u.useEffect(()=>{F()},[F]),u.useEffect(()=>{if(!(l!=null&&l.id))return;(async()=>{try{const i=await de(l.id);if(i){const d=P(i.envio,i.eventos);w(d),s(f=>f.map(x=>({...x,envios:x.envios.map(a=>a.id===d.id?d:a)})))}}catch(i){console.error("[EnviosView] Error cargando detalle:",i)}})()},[l==null?void 0:l.id]);const K=o=>{j(i=>{const d=new Set(i);return d.has(o)?d.delete(o):d.add(o),d})},I=async(o,i,d)=>{try{W(!0),await ce(o,{estado:i,descripcion_evento:d||`Estado cambiado a ${i}`,ubicacion:"Sistema",origen_evento:"manual"}),T.success("Estado actualizado"),await F()}catch{T.error("Error actualizando estado")}finally{W(!1)}},v=n.flatMap(o=>o.envios),h={total:v.length,entregados:v.filter(o=>o.estado==="entregado").length,en_transito:v.filter(o=>["en_transito","despachado","en_reparto","en_deposito"].includes(o.estado)).length,fallidos:v.filter(o=>o.estado==="fallido").length,pendientes:v.filter(o=>o.estado==="creado").length},A=u.useMemo(()=>n.filter(o=>!(!(!m||o.numero.toLowerCase().includes(m.toLowerCase())||o.cliente.toLowerCase().includes(m.toLowerCase())||o.envios.some(d=>d.numero.toLowerCase().includes(m.toLowerCase())||d.destinatario.toLowerCase().includes(m.toLowerCase())))||y!=="todos"&&!o.envios.some(d=>d.estado===y)||E!=="todos"&&!o.envios.some(d=>d.tramo===E))),[n,m,y,E]);return r?e.jsx("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#F8F9FA"},children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx(ee,{size:32,color:b,style:{animation:"spin 1s linear infinite"}}),e.jsx("p",{style:{color:"#6B7280",marginTop:12,fontSize:"0.875rem"},children:"Cargando env√≠os..."})]})}):e.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsx(Q,{icon:$,title:"Env√≠os",subtitle:`${h.total} env√≠os totales ¬∑ ${h.en_transito} en tr√°nsito ¬∑ ${h.entregados} entregados`,actions:[{label:"‚Üê Log√≠stica",onClick:()=>t("logistica")},{label:q?"Actualizando...":"üîÑ Actualizar",onClick:()=>F()},{label:"+ Nuevo Env√≠o",primary:!0,onClick:()=>{}}]}),e.jsxs("div",{style:{flex:1,display:"flex",overflow:"hidden",backgroundColor:"#F8F9FA"},children:[e.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(5,1fr)",gap:"12px",padding:"20px 20px 0"},children:[e.jsx(C,{label:"Total Env√≠os",value:h.total,color:"#6B7280",icon:_}),e.jsx(C,{label:"En Tr√°nsito",value:h.en_transito,color:"#7C3AED",icon:O}),e.jsx(C,{label:"En Reparto",value:v.filter(o=>o.estado==="en_reparto").length,color:b,icon:$}),e.jsx(C,{label:"Entregados",value:h.entregados,color:"#059669",icon:M}),e.jsx(C,{label:"Fallidos",value:h.fallidos,color:"#DC2626",icon:V,sub:h.fallidos>0?"Requieren atenci√≥n":void 0})]}),e.jsxs("div",{style:{display:"flex",gap:"10px",padding:"16px 20px",alignItems:"center",flexWrap:"wrap"},children:[e.jsxs("div",{style:{position:"relative",flex:1,minWidth:"200px"},children:[e.jsx(X,{size:14,color:"#9CA3AF",style:{position:"absolute",left:"10px",top:"50%",transform:"translateY(-50%)"}}),e.jsx("input",{value:m,onChange:o=>J(o.target.value),placeholder:"Buscar pedido, cliente, env√≠o...",style:{width:"100%",paddingLeft:"34px",paddingRight:"12px",paddingTop:"8px",paddingBottom:"8px",border:"1px solid #E5E7EB",borderRadius:"8px",fontSize:"13px",outline:"none",backgroundColor:"#fff",boxSizing:"border-box"}})]}),e.jsxs("select",{value:y,onChange:o=>U(o.target.value),style:{padding:"8px 12px",border:"1px solid #E5E7EB",borderRadius:"8px",fontSize:"13px",backgroundColor:"#fff",cursor:"pointer"},children:[e.jsx("option",{value:"todos",children:"Todos los estados"}),Object.entries(k).map(([o,i])=>e.jsx("option",{value:o,children:i.label},o))]}),e.jsxs("select",{value:E,onChange:o=>Y(o.target.value),style:{padding:"8px 12px",border:"1px solid #E5E7EB",borderRadius:"8px",fontSize:"13px",backgroundColor:"#fff",cursor:"pointer"},children:[e.jsx("option",{value:"todos",children:"Todos los tramos"}),Object.entries(B).map(([o,i])=>e.jsx("option",{value:o,children:i.label},o))]}),e.jsxs("span",{style:{fontSize:"12px",color:"#9CA3AF"},children:[A.length," pedidos ¬∑ ",A.flatMap(o=>o.envios).length," env√≠os"]})]}),e.jsx("div",{style:{flex:1,overflowY:"auto",padding:"0 20px 20px"},children:e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"10px"},children:A.map(o=>{const i=p.has(o.id),d=o.envios.map(a=>a.estado),f=d.includes("fallido"),x=d.every(a=>a==="entregado");return e.jsxs("div",{style:{backgroundColor:"#fff",borderRadius:"12px",border:`1px solid ${f?"#FCA5A5":x?"#A7F3D0":"#E5E7EB"}`,overflow:"hidden",boxShadow:"0 1px 4px rgba(0,0,0,0.04)"},children:[e.jsxs("button",{onClick:()=>K(o.id),style:{width:"100%",display:"flex",alignItems:"center",gap:"12px",padding:"14px 18px",border:"none",backgroundColor:x?"#F0FDF4":f?"#FFF5F5":"#FAFAFA",cursor:"pointer",textAlign:"left"},children:[i?e.jsx(ne,{size:16,color:"#6B7280"}):e.jsx(se,{size:16,color:"#6B7280"}),e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"10px",backgroundColor:x?"#D1FAE5":f?"#FEE2E2":"#FFF4EC",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:e.jsx(_,{size:16,color:x?"#059669":f?"#DC2626":b})}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("span",{style:{fontSize:"14px",fontWeight:800,color:"#111"},children:o.numero}),e.jsx("span",{style:{fontSize:"12px",color:"#6B7280"},children:"¬∑"}),e.jsx("span",{style:{fontSize:"13px",color:"#374151",fontWeight:500},children:o.cliente}),f&&e.jsx("span",{style:{fontSize:"10px",fontWeight:700,color:"#DC2626",backgroundColor:"#FEE2E2",padding:"2px 7px",borderRadius:"10px"},children:"‚ö† Tiene fallidos"}),x&&e.jsx("span",{style:{fontSize:"10px",fontWeight:700,color:"#059669",backgroundColor:"#D1FAE5",padding:"2px 7px",borderRadius:"10px"},children:"‚úì Todo entregado"})]}),e.jsxs("div",{style:{fontSize:"12px",color:"#9CA3AF",marginTop:"2px"},children:[o.envios.length," env√≠o",o.envios.length>1?"s":""," ¬∑ Total: $",o.total.toLocaleString("es-AR")]})]}),e.jsx("div",{style:{display:"flex",gap:"6px",flexShrink:0,flexWrap:"wrap"},children:o.envios.map(a=>e.jsx(R,{estado:a.estado},a.id))})]}),i&&e.jsx("div",{style:{borderTop:"1px solid #E5E7EB"},children:o.envios.map((a,g)=>{const S=k[a.estado],z=B[a.tramo];S.icon;const D=(l==null?void 0:l.id)===a.id;return e.jsxs("div",{onClick:()=>w(D?null:a),style:{display:"flex",alignItems:"center",gap:"12px",padding:"12px 18px 12px 50px",borderTop:g>0?"1px solid #F3F4F6":"none",cursor:"pointer",backgroundColor:D?"#FFF4EC":"transparent",transition:"background 0.12s"},children:[e.jsx("div",{style:{width:"6px",height:"6px",borderRadius:"50%",backgroundColor:S.color,flexShrink:0}}),e.jsxs("div",{style:{minWidth:0,flex:1},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontSize:"12px",fontWeight:700,color:"#374151",fontFamily:"monospace"},children:a.numero}),e.jsx(R,{estado:a.estado}),e.jsx("span",{style:{fontSize:"10px",fontWeight:600,color:z.color,backgroundColor:`${z.color}18`,padding:"2px 7px",borderRadius:"10px"},children:z.label}),e.jsx("span",{style:{fontSize:"11px",color:"#9CA3AF"},children:a.carrier})]}),e.jsxs("div",{style:{fontSize:"11px",color:"#9CA3AF",marginTop:"3px",display:"flex",gap:"12px",flexWrap:"wrap"},children:[e.jsxs("span",{children:["üìç ",a.destino]}),e.jsxs("span",{children:["üë§ ",a.destinatario]}),e.jsxs("span",{children:["üì¶ ",a.peso,"kg ¬∑ ",a.bultos," bulto",a.bultos>1?"s":""]}),e.jsxs("span",{children:["üìÖ Est. ",a.fechaEstimada]}),a.tracking&&e.jsxs("span",{style:{color:"#2563EB",fontWeight:600},children:["üîç ",a.tracking]})]})]}),e.jsx(ie,{size:14,color:D?b:"#D1D5DB"})]},a.id)})})]},o.id)})})})]}),l&&e.jsxs("div",{style:{width:"360px",backgroundColor:"#fff",borderLeft:"1px solid #E5E7EB",display:"flex",flexDirection:"column",overflow:"hidden",flexShrink:0},children:[e.jsxs("div",{style:{padding:"20px",borderBottom:"1px solid #E5E7EB",flexShrink:0},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"12px"},children:[e.jsx("span",{style:{fontSize:"13px",fontWeight:800,color:"#374151",fontFamily:"monospace"},children:l.numero}),e.jsx("button",{onClick:()=>w(null),style:{border:"none",background:"none",cursor:"pointer",color:"#9CA3AF",fontSize:"18px",lineHeight:1,padding:"2px"},children:"√ó"})]}),e.jsx(R,{estado:l.estado}),e.jsx("div",{style:{marginTop:"12px",display:"flex",flexDirection:"column",gap:"6px"},children:[["Carrier",l.carrier],["Tramo",B[l.tramo].label],["Origen",l.origen],["Destino",l.destino],["Destinatario",l.destinatario],["Peso",`${l.peso} kg ¬∑ ${l.bultos} bulto${l.bultos>1?"s":""}`],["F. estimada",l.fechaEstimada],...l.tracking?[["Tracking #",l.tracking]]:[]].map(([o,i])=>e.jsxs("div",{style:{display:"flex",gap:"8px",fontSize:"12px"},children:[e.jsx("span",{style:{color:"#9CA3AF",width:"90px",flexShrink:0},children:o}),e.jsx("span",{style:{color:"#111",fontWeight:500,flex:1},children:i})]},o))})]}),e.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"16px 20px"},children:[e.jsx("p",{style:{fontSize:"12px",fontWeight:700,color:"#374151",marginBottom:"14px",textTransform:"uppercase",letterSpacing:"0.06em"},children:"Historial de seguimiento"}),e.jsx("div",{style:{position:"relative"},children:l.eventos.map((o,i)=>{const d=k[o.estado],f=d.icon,x=i===0;return e.jsxs("div",{style:{display:"flex",gap:"12px",paddingBottom:"16px",position:"relative"},children:[i<l.eventos.length-1&&e.jsx("div",{style:{position:"absolute",left:"14px",top:"28px",bottom:0,width:"2px",backgroundColor:"#E5E7EB"}}),e.jsx("div",{style:{width:"28px",height:"28px",borderRadius:"50%",backgroundColor:x?d.bg:"#F3F4F6",border:`2px solid ${x?d.color:"#E5E7EB"}`,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,zIndex:1},children:e.jsx(f,{size:12,color:x?d.color:"#9CA3AF"})}),e.jsxs("div",{style:{flex:1,paddingTop:"4px"},children:[e.jsx("div",{style:{fontSize:"12px",fontWeight:x?700:500,color:x?d.color:"#374151"},children:o.descripcion}),e.jsxs("div",{style:{fontSize:"11px",color:"#9CA3AF",marginTop:"2px"},children:[o.ubicacion," ¬∑ ",o.fecha," ",o.hora]})]})]},i)})})]}),e.jsxs("div",{style:{padding:"14px 16px",borderTop:"1px solid #E5E7EB",display:"flex",gap:"8px",flexShrink:0},children:[e.jsx("button",{style:{flex:1,padding:"9px",border:`1.5px solid ${b}`,borderRadius:"8px",backgroundColor:"transparent",color:b,fontSize:"12px",fontWeight:700,cursor:"pointer"},children:"Ver tracking externo"}),l.estado==="fallido"&&e.jsx("button",{onClick:()=>I(l.id,"creado","Re-despachado despu√©s de fallo"),style:{flex:1,padding:"9px",border:"none",borderRadius:"8px",backgroundColor:b,color:"#fff",fontSize:"12px",fontWeight:700,cursor:"pointer"},children:"Re-despachar"}),l.estado==="creado"&&e.jsx("button",{onClick:()=>I(l.id,"despachado","Env√≠o despachado"),style:{flex:1,padding:"9px",border:"none",borderRadius:"8px",backgroundColor:"#2563EB",color:"#fff",fontSize:"12px",fontWeight:700,cursor:"pointer"},children:"Despachar"})]})]})]})]})}export{ze as EnviosView};
