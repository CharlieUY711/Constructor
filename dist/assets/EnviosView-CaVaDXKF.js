import{s as b,r as h,t as B,j as e,T as I,P as W,f as U}from"./index-D8gJryvN.js";import{O as K}from"./OrangeHeader-CD_39fGA.js";import{L as X}from"./loader-circle-bsIAMbtG.js";import{N as O}from"./navigation-DfF8Lrq8.js";import{C as P}from"./circle-check-Dz8HUzMY.js";import{C as q}from"./circle-x-DWUrf7kw.js";import{R as J}from"./rotate-ccw-mUUZrgZ1.js";import{M as Q}from"./map-pin-C0eCdOxB.js";import{L as Z}from"./layers-DMA1H7Sb.js";import{C as ee}from"./chevron-down-P8DIozcF.js";import{C as oe}from"./chevron-right-CsAaBlXb.js";import{E as te}from"./eye-DYAFaFCx.js";import"./ConnectionStatusIcon-D1UUScUD.js";import"./zap-DVZ7QpUM.js";import"./lightbulb-Baf-YTXC.js";async function re(t){let r=b.from("envios").select("*").order("fecha_creacion",{ascending:!1});t!=null&&t.pedido_madre_id&&(r=r.eq("pedido_madre_id",t.pedido_madre_id)),t!=null&&t.estado&&(r=r.eq("estado",t.estado)),t!=null&&t.carrier&&(r=r.eq("carrier",t.carrier)),t!=null&&t.tramo&&(r=r.eq("tramo",t.tramo));const{data:i,error:d}=await r;if(d)throw console.error("[enviosApi] Error obteniendo env√≠os:",d),new Error(d.message||"Error cargando env√≠os");const c=(i==null?void 0:i.map(g=>g.id))||[];let f=[];if(c.length>0){const{data:g,error:n}=await b.from("envios_eventos").select("*").in("envio_id",c).order("fecha",{ascending:!1});!n&&g&&(f=g)}return{envios:i||[],eventos:f}}async function ne(t){const{data:r,error:i}=await b.from("envios").select("*").eq("id",t).single();if(i)return console.error("[enviosApi] Error obteniendo env√≠o:",i),null;if(!r)return null;const{data:d,error:c}=await b.from("envios_eventos").select("*").eq("envio_id",t).order("fecha",{ascending:!1});return c&&console.error("[enviosApi] Error obteniendo eventos:",c),{envio:r,eventos:d||[]}}async function se(t,r){const{descripcion_evento:i,ubicacion:d,origen_evento:c,...f}=r,{data:g,error:n}=await b.from("envios").update({...f,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(n)throw console.error("[enviosApi] Error actualizando env√≠o:",n),new Error(n.message||"Error actualizando env√≠o");return i&&g&&await ie(t,{estado:f.estado||g.estado,descripcion:i,ubicacion:d,origen:c||"manual"}),g}async function ie(t,r){const{data:i}=await b.from("envios").select("estado").eq("id",t).single(),{data:d,error:c}=await b.from("envios_eventos").insert({envio_id:t,estado:r.estado,descripcion:r.descripcion,ubicacion:r.ubicacion,lat:r.lat,lng:r.lng,origen:r.origen||"manual",fecha:new Date().toISOString()}).select().single();if(c)throw console.error("[enviosApi] Error agregando evento:",c),new Error(c.message||"Error agregando evento");return i&&i.estado!==r.estado&&await b.from("envios").update({estado:r.estado,updated_at:new Date().toISOString()}).eq("id",t),d}const j="#FF6835";function M(t,r=[]){const i=new Date(t.fecha_creacion),d=t.fecha_estimada||"",c=r.map(f=>{const g=new Date(f.fecha);return{fecha:g.toLocaleDateString("es-AR",{day:"2-digit",month:"2-digit"}),hora:g.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit"}),estado:f.estado,descripcion:f.descripcion,ubicacion:f.ubicacion||"Sistema"}});return{id:t.id,numero:t.numero,pedidoMadre:t.numero_pedido||t.pedido_madre_id||"",estado:t.estado,origen:t.origen,destino:t.destino,destinatario:t.destinatario,carrier:t.carrier,tramo:t.tramo,peso:Number(t.peso)||0,bultos:t.bultos||1,fechaCreacion:i.toISOString().split("T")[0],fechaEstimada:d,tracking:t.tracking,eventos:c,envioData:t,eventosData:r}}function ae(t){const r=new Map;return t.forEach(i=>{const d=i.pedidoMadre||"sin-pedido";r.has(d)||r.set(d,{numero:i.pedidoMadre||"Sin pedido",cliente:i.destinatario,envios:[],total:0});const c=r.get(d);c.envios.push(i),c.total+=0}),Array.from(r.entries()).map(([i,d])=>({id:i,...d}))}const k={creado:{label:"Creado",color:"#6B7280",bg:"#F3F4F6",icon:W},despachado:{label:"Despachado",color:"#2563EB",bg:"#EFF6FF",icon:I},en_transito:{label:"En tr√°nsito",color:"#7C3AED",bg:"#F5F3FF",icon:O},en_deposito:{label:"En dep√≥sito",color:"#D97706",bg:"#FFFBEB",icon:Z},en_reparto:{label:"En reparto",color:"#FF6835",bg:"#FFF4EC",icon:Q},entregado:{label:"Entregado",color:"#059669",bg:"#ECFDF5",icon:P},fallido:{label:"Fallido",color:"#DC2626",bg:"#FEF2F2",icon:q},devuelto:{label:"Devuelto",color:"#9CA3AF",bg:"#F9FAFB",icon:J}},R={local:{label:"Local",color:"#059669"},intercity:{label:"Intercity",color:"#2563EB"},internacional:{label:"Internacional",color:"#7C3AED"},last_mile:{label:"Last Mile",color:"#D97706"}};function F({label:t,value:r,sub:i,color:d,icon:c}){return e.jsxs("div",{style:{backgroundColor:"#fff",borderRadius:"12px",border:"1px solid #E5E7EB",padding:"16px 20px",display:"flex",gap:"14px",alignItems:"center"},children:[e.jsx("div",{style:{width:"44px",height:"44px",borderRadius:"12px",backgroundColor:`${d}18`,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:e.jsx(c,{size:20,color:d})}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"22px",fontWeight:800,color:"#111",lineHeight:1},children:r}),e.jsx("div",{style:{fontSize:"12px",color:"#6B7280",marginTop:"3px"},children:t}),i&&e.jsx("div",{style:{fontSize:"11px",color:d,marginTop:"2px",fontWeight:600},children:i})]})]})}function T({estado:t}){const r=k[t],i=r.icon;return e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"5px",fontSize:"11px",fontWeight:700,padding:"3px 9px",borderRadius:"20px",backgroundColor:r.bg,color:r.color,whiteSpace:"nowrap"},children:[e.jsx(i,{size:11})," ",r.label]})}function Ce({onNavigate:t}){const[r,i]=h.useState([]),[d,c]=h.useState(!0),[f,g]=h.useState(new Set),[n,A]=h.useState(null),[v,V]=h.useState(""),[E,N]=h.useState("todos"),[y,H]=h.useState("todos"),[G,L]=h.useState(!1),S=h.useCallback(async()=>{try{c(!0),console.log("[EnviosView] Iniciando carga de env√≠os...");const o={};E!=="todos"&&(o.estado=E),y!=="todos"&&(o.tramo=y),console.log("[EnviosView] Filtros aplicados:",o);const{envios:s,eventos:l}=await re(o);console.log("[EnviosView] Datos recibidos:",{envios:s.length,eventos:l.length});const x=new Map;l.forEach(u=>{x.has(u.envio_id)||x.set(u.envio_id,[]),x.get(u.envio_id).push(u)}),console.log("[EnviosView] Eventos agrupados por env√≠o:",x.size);const p=s.map(u=>{const w=x.get(u.id)||[];return M(u,w)});console.log("[EnviosView] Env√≠os transformados:",p.length);const a=ae(p);console.log("[EnviosView] Pedidos agrupados:",a.length),i(a),g(u=>u.size===0&&a.length>0?new Set([a[0].id]):u)}catch(o){console.error("[EnviosView] Error cargando env√≠os:",o);let s="Error desconocido";o instanceof Error?s=o.message:typeof o=="object"&&o!==null?"message"in o&&typeof o.message=="string"?s=o.message:"error"in o&&typeof o.error=="string"?s=o.error:s="Error al cargar env√≠os. Por favor, intenta nuevamente.":s=String(o),B.error(`Error al cargar env√≠os: ${s}`),i([])}finally{c(!1)}},[E,y]);h.useEffect(()=>{S()},[S]),h.useEffect(()=>{if(!(n!=null&&n.id))return;(async()=>{try{const s=await ne(n.id);if(s){const l=M(s.envio,s.eventos);A(l),i(x=>x.map(p=>({...p,envios:p.envios.map(a=>a.id===l.id?l:a)})))}}catch(s){console.error("[EnviosView] Error cargando detalle:",s)}})()},[n==null?void 0:n.id]);const Y=o=>{g(s=>{const l=new Set(s);return l.has(o)?l.delete(o):l.add(o),l})},$=async(o,s,l)=>{try{L(!0),await se(o,{estado:s,descripcion_evento:l||`Estado cambiado a ${s}`,ubicacion:"Sistema",origen_evento:"manual"}),B.success("Estado actualizado"),await S()}catch{B.error("Error actualizando estado")}finally{L(!1)}},C=r.flatMap(o=>o.envios),m={total:C.length,entregados:C.filter(o=>o.estado==="entregado").length,en_transito:C.filter(o=>["en_transito","despachado","en_reparto","en_deposito"].includes(o.estado)).length,fallidos:C.filter(o=>o.estado==="fallido").length,pendientes:C.filter(o=>o.estado==="creado").length},z=h.useMemo(()=>r.filter(o=>!(!(!v||o.numero.toLowerCase().includes(v.toLowerCase())||o.cliente.toLowerCase().includes(v.toLowerCase())||o.envios.some(l=>l.numero.toLowerCase().includes(v.toLowerCase())||l.destinatario.toLowerCase().includes(v.toLowerCase())))||E!=="todos"&&!o.envios.some(l=>l.estado===E)||y!=="todos"&&!o.envios.some(l=>l.tramo===y))),[r,v,E,y]);return d?e.jsx("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#F8F9FA"},children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx(X,{size:32,color:j,style:{animation:"spin 1s linear infinite"}}),e.jsx("p",{style:{color:"#6B7280",marginTop:12,fontSize:"0.875rem"},children:"Cargando env√≠os..."})]})}):e.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsx(K,{icon:I,title:"Env√≠os",subtitle:`${m.total} env√≠os totales ¬∑ ${m.en_transito} en tr√°nsito ¬∑ ${m.entregados} entregados`,actions:[{label:"‚Üê Log√≠stica",onClick:()=>t("logistica")},{label:G?"Actualizando...":"üîÑ Actualizar",onClick:()=>S()},{label:"+ Nuevo Env√≠o",primary:!0,onClick:()=>{}}]}),e.jsxs("div",{style:{flex:1,display:"flex",overflow:"hidden",backgroundColor:"#F8F9FA"},children:[e.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(5,1fr)",gap:"12px",padding:"20px 20px 0"},children:[e.jsx(F,{label:"Total Env√≠os",value:m.total,color:"#6B7280",icon:W}),e.jsx(F,{label:"En Tr√°nsito",value:m.en_transito,color:"#7C3AED",icon:O}),e.jsx(F,{label:"En Reparto",value:C.filter(o=>o.estado==="en_reparto").length,color:j,icon:I}),e.jsx(F,{label:"Entregados",value:m.entregados,color:"#059669",icon:P}),e.jsx(F,{label:"Fallidos",value:m.fallidos,color:"#DC2626",icon:q,sub:m.fallidos>0?"Requieren atenci√≥n":void 0})]}),e.jsxs("div",{style:{display:"flex",gap:"10px",padding:"16px 20px",alignItems:"center",flexWrap:"wrap"},children:[e.jsxs("div",{style:{position:"relative",flex:1,minWidth:"200px"},children:[e.jsx(U,{size:14,color:"#9CA3AF",style:{position:"absolute",left:"10px",top:"50%",transform:"translateY(-50%)"}}),e.jsx("input",{value:v,onChange:o=>V(o.target.value),placeholder:"Buscar pedido, cliente, env√≠o...",style:{width:"100%",paddingLeft:"34px",paddingRight:"12px",paddingTop:"8px",paddingBottom:"8px",border:"1px solid #E5E7EB",borderRadius:"8px",fontSize:"13px",outline:"none",backgroundColor:"#fff",boxSizing:"border-box"}})]}),e.jsxs("select",{value:E,onChange:o=>N(o.target.value),style:{padding:"8px 12px",border:"1px solid #E5E7EB",borderRadius:"8px",fontSize:"13px",backgroundColor:"#fff",cursor:"pointer"},children:[e.jsx("option",{value:"todos",children:"Todos los estados"}),Object.entries(k).map(([o,s])=>e.jsx("option",{value:o,children:s.label},o))]}),e.jsxs("select",{value:y,onChange:o=>H(o.target.value),style:{padding:"8px 12px",border:"1px solid #E5E7EB",borderRadius:"8px",fontSize:"13px",backgroundColor:"#fff",cursor:"pointer"},children:[e.jsx("option",{value:"todos",children:"Todos los tramos"}),Object.entries(R).map(([o,s])=>e.jsx("option",{value:o,children:s.label},o))]}),e.jsxs("span",{style:{fontSize:"12px",color:"#9CA3AF"},children:[z.length," pedidos ¬∑ ",z.flatMap(o=>o.envios).length," env√≠os"]})]}),e.jsx("div",{style:{flex:1,overflowY:"auto",padding:"0 20px 20px"},children:e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"10px"},children:z.map(o=>{const s=f.has(o.id),l=o.envios.map(a=>a.estado),x=l.includes("fallido"),p=l.every(a=>a==="entregado");return e.jsxs("div",{style:{backgroundColor:"#fff",borderRadius:"12px",border:`1px solid ${x?"#FCA5A5":p?"#A7F3D0":"#E5E7EB"}`,overflow:"hidden",boxShadow:"0 1px 4px rgba(0,0,0,0.04)"},children:[e.jsxs("button",{onClick:()=>Y(o.id),style:{width:"100%",display:"flex",alignItems:"center",gap:"12px",padding:"14px 18px",border:"none",backgroundColor:p?"#F0FDF4":x?"#FFF5F5":"#FAFAFA",cursor:"pointer",textAlign:"left"},children:[s?e.jsx(ee,{size:16,color:"#6B7280"}):e.jsx(oe,{size:16,color:"#6B7280"}),e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"10px",backgroundColor:p?"#D1FAE5":x?"#FEE2E2":"#FFF4EC",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:e.jsx(W,{size:16,color:p?"#059669":x?"#DC2626":j})}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("span",{style:{fontSize:"14px",fontWeight:800,color:"#111"},children:o.numero}),e.jsx("span",{style:{fontSize:"12px",color:"#6B7280"},children:"¬∑"}),e.jsx("span",{style:{fontSize:"13px",color:"#374151",fontWeight:500},children:o.cliente}),x&&e.jsx("span",{style:{fontSize:"10px",fontWeight:700,color:"#DC2626",backgroundColor:"#FEE2E2",padding:"2px 7px",borderRadius:"10px"},children:"‚ö† Tiene fallidos"}),p&&e.jsx("span",{style:{fontSize:"10px",fontWeight:700,color:"#059669",backgroundColor:"#D1FAE5",padding:"2px 7px",borderRadius:"10px"},children:"‚úì Todo entregado"})]}),e.jsxs("div",{style:{fontSize:"12px",color:"#9CA3AF",marginTop:"2px"},children:[o.envios.length," env√≠o",o.envios.length>1?"s":""," ¬∑ Total: $",o.total.toLocaleString("es-AR")]})]}),e.jsx("div",{style:{display:"flex",gap:"6px",flexShrink:0,flexWrap:"wrap"},children:o.envios.map(a=>e.jsx(T,{estado:a.estado},a.id))})]}),s&&e.jsx("div",{style:{borderTop:"1px solid #E5E7EB"},children:o.envios.map((a,u)=>{const w=k[a.estado],D=R[a.tramo];w.icon;const _=(n==null?void 0:n.id)===a.id;return e.jsxs("div",{onClick:()=>A(_?null:a),style:{display:"flex",alignItems:"center",gap:"12px",padding:"12px 18px 12px 50px",borderTop:u>0?"1px solid #F3F4F6":"none",cursor:"pointer",backgroundColor:_?"#FFF4EC":"transparent",transition:"background 0.12s"},children:[e.jsx("div",{style:{width:"6px",height:"6px",borderRadius:"50%",backgroundColor:w.color,flexShrink:0}}),e.jsxs("div",{style:{minWidth:0,flex:1},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontSize:"12px",fontWeight:700,color:"#374151",fontFamily:"monospace"},children:a.numero}),e.jsx(T,{estado:a.estado}),e.jsx("span",{style:{fontSize:"10px",fontWeight:600,color:D.color,backgroundColor:`${D.color}18`,padding:"2px 7px",borderRadius:"10px"},children:D.label}),e.jsx("span",{style:{fontSize:"11px",color:"#9CA3AF"},children:a.carrier})]}),e.jsxs("div",{style:{fontSize:"11px",color:"#9CA3AF",marginTop:"3px",display:"flex",gap:"12px",flexWrap:"wrap"},children:[e.jsxs("span",{children:["üìç ",a.destino]}),e.jsxs("span",{children:["üë§ ",a.destinatario]}),e.jsxs("span",{children:["üì¶ ",a.peso,"kg ¬∑ ",a.bultos," bulto",a.bultos>1?"s":""]}),e.jsxs("span",{children:["üìÖ Est. ",a.fechaEstimada]}),a.tracking&&e.jsxs("span",{style:{color:"#2563EB",fontWeight:600},children:["üîç ",a.tracking]})]})]}),e.jsx(te,{size:14,color:_?j:"#D1D5DB"})]},a.id)})})]},o.id)})})})]}),n&&e.jsxs("div",{style:{width:"360px",backgroundColor:"#fff",borderLeft:"1px solid #E5E7EB",display:"flex",flexDirection:"column",overflow:"hidden",flexShrink:0},children:[e.jsxs("div",{style:{padding:"20px",borderBottom:"1px solid #E5E7EB",flexShrink:0},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"12px"},children:[e.jsx("span",{style:{fontSize:"13px",fontWeight:800,color:"#374151",fontFamily:"monospace"},children:n.numero}),e.jsx("button",{onClick:()=>A(null),style:{border:"none",background:"none",cursor:"pointer",color:"#9CA3AF",fontSize:"18px",lineHeight:1,padding:"2px"},children:"√ó"})]}),e.jsx(T,{estado:n.estado}),e.jsx("div",{style:{marginTop:"12px",display:"flex",flexDirection:"column",gap:"6px"},children:[["Carrier",n.carrier],["Tramo",R[n.tramo].label],["Origen",n.origen],["Destino",n.destino],["Destinatario",n.destinatario],["Peso",`${n.peso} kg ¬∑ ${n.bultos} bulto${n.bultos>1?"s":""}`],["F. estimada",n.fechaEstimada],...n.tracking?[["Tracking #",n.tracking]]:[]].map(([o,s])=>e.jsxs("div",{style:{display:"flex",gap:"8px",fontSize:"12px"},children:[e.jsx("span",{style:{color:"#9CA3AF",width:"90px",flexShrink:0},children:o}),e.jsx("span",{style:{color:"#111",fontWeight:500,flex:1},children:s})]},o))})]}),e.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"16px 20px"},children:[e.jsx("p",{style:{fontSize:"12px",fontWeight:700,color:"#374151",marginBottom:"14px",textTransform:"uppercase",letterSpacing:"0.06em"},children:"Historial de seguimiento"}),e.jsx("div",{style:{position:"relative"},children:n.eventos.map((o,s)=>{const l=k[o.estado],x=l.icon,p=s===0;return e.jsxs("div",{style:{display:"flex",gap:"12px",paddingBottom:"16px",position:"relative"},children:[s<n.eventos.length-1&&e.jsx("div",{style:{position:"absolute",left:"14px",top:"28px",bottom:0,width:"2px",backgroundColor:"#E5E7EB"}}),e.jsx("div",{style:{width:"28px",height:"28px",borderRadius:"50%",backgroundColor:p?l.bg:"#F3F4F6",border:`2px solid ${p?l.color:"#E5E7EB"}`,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,zIndex:1},children:e.jsx(x,{size:12,color:p?l.color:"#9CA3AF"})}),e.jsxs("div",{style:{flex:1,paddingTop:"4px"},children:[e.jsx("div",{style:{fontSize:"12px",fontWeight:p?700:500,color:p?l.color:"#374151"},children:o.descripcion}),e.jsxs("div",{style:{fontSize:"11px",color:"#9CA3AF",marginTop:"2px"},children:[o.ubicacion," ¬∑ ",o.fecha," ",o.hora]})]})]},s)})})]}),e.jsxs("div",{style:{padding:"14px 16px",borderTop:"1px solid #E5E7EB",display:"flex",gap:"8px",flexShrink:0},children:[e.jsx("button",{style:{flex:1,padding:"9px",border:`1.5px solid ${j}`,borderRadius:"8px",backgroundColor:"transparent",color:j,fontSize:"12px",fontWeight:700,cursor:"pointer"},children:"Ver tracking externo"}),n.estado==="fallido"&&e.jsx("button",{onClick:()=>$(n.id,"creado","Re-despachado despu√©s de fallo"),style:{flex:1,padding:"9px",border:"none",borderRadius:"8px",backgroundColor:j,color:"#fff",fontSize:"12px",fontWeight:700,cursor:"pointer"},children:"Re-despachar"}),n.estado==="creado"&&e.jsx("button",{onClick:()=>$(n.id,"despachado","Env√≠o despachado"),style:{flex:1,padding:"9px",border:"none",borderRadius:"8px",backgroundColor:"#2563EB",color:"#fff",fontSize:"12px",fontWeight:700,cursor:"pointer"},children:"Despachar"})]})]})]})]})}export{Ce as EnviosView};
