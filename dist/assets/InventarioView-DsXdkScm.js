import{s as u,R as a,j as e,t as c}from"./index-C7B7W1lQ.js";import{O as M}from"./OrangeHeader-CoTBbwWn.js";import{g as U}from"./depositosApi-BFR6O1vX.js";import{T as R}from"./triangle-alert-VEMrm09l.js";import{L as K}from"./loader-circle-FhFeU9ES.js";import{A as O}from"./arrow-up-DovqIm2v.js";import{P}from"./pen-IKWzVw_A.js";import{T as G}from"./trash-2-By_1iggs.js";import"./zap-DaP38y9l.js";import"./lightbulb-QoB3Dxu8.js";import"./map-pin-QypTHBjh.js";const j="oddy";async function H(i){let o=u.from("inventario").select("*, depositos(id, nombre, ciudad)").eq("tenant_id",j).order("nombre");i!=null&&i.deposito_id&&(o=o.eq("deposito_id",i.deposito_id)),i!=null&&i.categoria&&(o=o.eq("categoria",i.categoria)),i!=null&&i.search&&(o=o.ilike("nombre",`%${i.search}%`));const{data:s,error:n}=await o;if(n)throw console.error("[inventarioApi] Error obteniendo inventario:",n),new Error(n.message||"Error cargando inventario");const x=s||[],p=x.filter(d=>d.cantidad<=d.cantidad_minima);return{data:x,alertas_count:p.length}}async function L(i){if(!i.sku||!i.nombre||!i.deposito_id)throw new Error("sku, nombre y deposito_id son requeridos");const{data:o,error:s}=await u.from("inventario").insert({...i,tenant_id:j,cantidad:i.cantidad??0}).select().single();if(s)throw console.error("[inventarioApi] Error creando item:",s),new Error(s.message||"Error creando item");return o}async function V(i,o){const{data:s,error:n}=await u.from("inventario").update({...o,updated_at:new Date().toISOString()}).eq("id",i).eq("tenant_id",j).select().single();if(n)throw console.error("[inventarioApi] Error actualizando item:",n),new Error(n.message||"Error actualizando item");return s}async function Y(i,o){if(!o.tipo||!o.cantidad)throw new Error("tipo y cantidad son requeridos");if(!["entrada","salida","ajuste","transferencia"].includes(o.tipo))throw new Error("tipo inválido");const{data:s,error:n}=await u.from("inventario").select("cantidad").eq("id",i).single();if(n)throw console.error("[inventarioApi] Error obteniendo item para movimiento:",n),new Error(n.message||"Error obteniendo item");const x=o.tipo==="salida"?-Math.abs(o.cantidad):Math.abs(o.cantidad),p=o.tipo==="ajuste"?o.cantidad:s.cantidad+x;if(p<0)throw new Error("Stock insuficiente");const[d,g]=await Promise.all([u.from("inventario_movimientos").insert({tenant_id:j,inventario_id:i,tipo:o.tipo,cantidad:o.cantidad,referencia:o.referencia,notas:o.notas,usuario_id:o.usuario_id}),u.from("inventario").update({cantidad:p,updated_at:new Date().toISOString()}).eq("id",i)]);if(d.error)throw console.error("[inventarioApi] Error registrando movimiento:",d.error),new Error(d.error.message||"Error registrando movimiento");if(g.error)throw console.error("[inventarioApi] Error actualizando cantidad:",g.error),new Error(g.error.message||"Error actualizando cantidad");return{success:!0,cantidad_anterior:s.cantidad,cantidad_nueva:p}}async function $(i){const{error:o}=await u.from("inventario").delete().eq("id",i).eq("tenant_id",j);return o?(console.error("[inventarioApi] Error eliminando item:",o),!1):!0}const E="#FF6835";function se({onNavigate:i}){const[o,s]=a.useState([]),[n,x]=a.useState([]),[p,d]=a.useState(!0),[g,A]=a.useState(""),[k,W]=a.useState(""),[_,q]=a.useState(0),[I,v]=a.useState(!1),[f,B]=a.useState(null),[z,F]=a.useState(null),[l,b]=a.useState({}),[m,C]=a.useState({tipo:"entrada",cantidad:0,notas:""}),[S,w]=a.useState(!1),y=async()=>{d(!0);try{const[t,r]=await Promise.all([H({deposito_id:k||void 0,search:g||void 0}),U()]);s(t.data),q(t.alertas_count),x(r)}catch{c.error("Error")}finally{d(!1)}};a.useEffect(()=>{y()},[k]);const N=async()=>{if(!l.sku||!l.nombre||!l.deposito_id)return c.error("SKU, nombre y deposito requeridos");w(!0);try{z?(await V(z,l),c.success("Actualizado")):(await L(l),c.success("Creado")),v(!1),y()}catch{c.error("Error")}finally{w(!1)}},T=async()=>{if(!f||!m.cantidad)return c.error("Cantidad requerida");w(!0);try{const t=await Y(f.id,m);c.success("Stock: "+t.cantidad_anterior+" a "+t.cantidad_nueva),B(null),y()}catch(t){c.error(t.message||"Error")}finally{w(!1)}};return e.jsxs("div",{style:{minHeight:"100vh",background:"#F8FAFC"},children:[e.jsx(M,{title:"Inventario",subtitle:"Stock por deposito",onBack:()=>i("logistica")}),e.jsxs("div",{style:{maxWidth:1200,margin:"0 auto",padding:"24px 16px"},children:[_>0&&e.jsxs("div",{style:{background:"#FEF3C7",border:"1px solid #F59E0B",borderRadius:10,padding:"12px 16px",marginBottom:20,display:"flex",alignItems:"center",gap:10},children:[e.jsx(R,{size:18,style:{color:"#F59E0B"}}),e.jsxs("strong",{children:[_," item(s) bajo stock minimo"]})]}),e.jsxs("div",{style:{display:"flex",gap:10,marginBottom:20,flexWrap:"wrap"},children:[e.jsx("input",{value:g,onChange:t=>A(t.target.value),onKeyDown:t=>{t.key==="Enter"&&y()},placeholder:"Buscar SKU o nombre (Enter)...",style:{flex:1,minWidth:200,padding:"9px 12px",border:"1px solid #E5E7EB",borderRadius:8,fontSize:14}}),e.jsxs("select",{value:k,onChange:t=>W(t.target.value),style:{border:"1px solid #E5E7EB",borderRadius:8,padding:"9px 12px",fontSize:14},children:[e.jsx("option",{value:"",children:"Todos los depositos"}),n.map(t=>e.jsx("option",{value:t.id,children:t.nombre},t.id))]}),e.jsx("button",{onClick:()=>{b({}),F(null),v(!0)},style:{background:E,color:"#fff",border:"none",borderRadius:8,padding:"9px 16px",fontWeight:600,cursor:"pointer"},children:"+ Nuevo"})]}),p?e.jsx("div",{style:{textAlign:"center",padding:60},children:e.jsx(K,{size:32,style:{color:E}})}):e.jsx("div",{style:{background:"#fff",border:"1px solid #E5E7EB",borderRadius:12,overflow:"hidden"},children:e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsx("tr",{style:{background:"#F9FAFB"},children:["SKU","Nombre","Deposito","Stock","Min",""].map(t=>e.jsx("th",{style:{padding:"12px 16px",textAlign:"left",fontSize:12,fontWeight:600,color:"#6B7280"},children:t},t))})}),e.jsx("tbody",{children:o.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,style:{textAlign:"center",padding:40,color:"#9CA3AF"},children:"No hay items"})}):o.map(t=>{var h;const r=t.cantidad<=t.cantidad_minima;return e.jsxs("tr",{style:{borderBottom:"1px solid #F3F4F6",background:r?"#FFFBEB":"#fff"},children:[e.jsx("td",{style:{padding:"12px 16px",fontFamily:"monospace",fontWeight:600},children:t.sku}),e.jsxs("td",{style:{padding:"12px 16px"},children:[r&&e.jsx(R,{size:13,style:{color:"#F59E0B",marginRight:4,verticalAlign:"middle"}}),t.nombre]}),e.jsx("td",{style:{padding:"12px 16px",color:"#6B7280",fontSize:13},children:((h=t.depositos)==null?void 0:h.nombre)||"-"}),e.jsx("td",{style:{padding:"12px 16px",fontWeight:700,color:r?"#D97706":"#111"},children:t.cantidad}),e.jsx("td",{style:{padding:"12px 16px",color:"#9CA3AF",fontSize:13},children:t.cantidad_minima}),e.jsxs("td",{style:{padding:"12px 16px"},children:[e.jsx("button",{onClick:()=>B(t),style:{background:"#F0FDF4",border:"none",borderRadius:6,padding:"5px 8px",cursor:"pointer",color:"#059669",marginRight:4},children:e.jsx(O,{size:13})}),e.jsx("button",{onClick:()=>{b(t),F(t.id),v(!0)},style:{background:"none",border:"none",cursor:"pointer",color:"#6B7280",marginRight:4},children:e.jsx(P,{size:13})}),e.jsx("button",{onClick:async()=>{confirm("Eliminar?")&&(await $(t.id),y())},style:{background:"none",border:"none",cursor:"pointer",color:"#EF4444"},children:e.jsx(G,{size:13})})]})]},t.id)})})]})}),I&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsxs("div",{style:{background:"#fff",borderRadius:14,padding:28,width:"100%",maxWidth:480,maxHeight:"90vh",overflowY:"auto"},children:[e.jsxs("h3",{style:{margin:"0 0 20px"},children:[z?"Editar":"Nuevo"," item"]}),e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("label",{style:{fontSize:13,fontWeight:600,display:"block",marginBottom:4},children:"Deposito *"}),e.jsxs("select",{value:l.deposito_id||"",onChange:t=>b(r=>({...r,deposito_id:t.target.value})),style:{width:"100%",border:"1px solid #D1D5DB",borderRadius:8,padding:"9px 12px",fontSize:14},children:[e.jsx("option",{value:"",children:"Seleccionar..."}),n.map(t=>e.jsx("option",{value:t.id,children:t.nombre},t.id))]})]}),[["sku","SKU *"],["nombre","Nombre *"],["categoria","Categoria"],["ubicacion","Ubicacion"]].map(([t,r])=>e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("label",{style:{fontSize:13,fontWeight:600,display:"block",marginBottom:4},children:r}),e.jsx("input",{value:l[t]||"",onChange:h=>b(D=>({...D,[t]:h.target.value})),style:{width:"100%",border:"1px solid #D1D5DB",borderRadius:8,padding:"9px 12px",fontSize:14,boxSizing:"border-box"}})]},t)),[["cantidad","Stock inicial"],["cantidad_minima","Stock minimo"],["costo_unitario","Costo unitario"]].map(([t,r])=>e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("label",{style:{fontSize:13,fontWeight:600,display:"block",marginBottom:4},children:r}),e.jsx("input",{type:"number",value:l[t]??"",onChange:h=>b(D=>({...D,[t]:Number(h.target.value)})),style:{width:"100%",border:"1px solid #D1D5DB",borderRadius:8,padding:"9px 12px",fontSize:14,boxSizing:"border-box"}})]},t)),e.jsxs("div",{style:{display:"flex",gap:10,justifyContent:"flex-end",marginTop:20},children:[e.jsx("button",{onClick:()=>v(!1),style:{padding:"9px 18px",border:"1px solid #D1D5DB",borderRadius:8,cursor:"pointer"},children:"Cancelar"}),e.jsx("button",{onClick:N,disabled:S,style:{padding:"9px 18px",background:E,color:"#fff",border:"none",borderRadius:8,fontWeight:600,cursor:"pointer"},children:S?"Guardando...":"Guardar"})]})]})}),f&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsxs("div",{style:{background:"#fff",borderRadius:14,padding:28,width:"100%",maxWidth:400},children:[e.jsx("h3",{style:{margin:"0 0 6px"},children:"Movimiento de stock"}),e.jsxs("p",{style:{margin:"0 0 20px",color:"#6B7280",fontSize:14},children:[f.nombre," — Stock actual: ",e.jsx("strong",{children:f.cantidad})]}),e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("label",{style:{fontSize:13,fontWeight:600,display:"block",marginBottom:4},children:"Tipo"}),e.jsxs("select",{value:m.tipo,onChange:t=>C(r=>({...r,tipo:t.target.value})),style:{width:"100%",border:"1px solid #D1D5DB",borderRadius:8,padding:"9px 12px",fontSize:14},children:[e.jsx("option",{value:"entrada",children:"Entrada"}),e.jsx("option",{value:"salida",children:"Salida"}),e.jsx("option",{value:"ajuste",children:"Ajuste (cantidad exacta)"})]})]}),e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("label",{style:{fontSize:13,fontWeight:600,display:"block",marginBottom:4},children:"Cantidad"}),e.jsx("input",{type:"number",value:m.cantidad,onChange:t=>C(r=>({...r,cantidad:Number(t.target.value)})),style:{width:"100%",border:"1px solid #D1D5DB",borderRadius:8,padding:"9px 12px",fontSize:14,boxSizing:"border-box"}})]}),e.jsxs("div",{style:{marginBottom:20},children:[e.jsx("label",{style:{fontSize:13,fontWeight:600,display:"block",marginBottom:4},children:"Notas"}),e.jsx("input",{value:m.notas,onChange:t=>C(r=>({...r,notas:t.target.value})),style:{width:"100%",border:"1px solid #D1D5DB",borderRadius:8,padding:"9px 12px",fontSize:14,boxSizing:"border-box"}})]}),e.jsxs("div",{style:{display:"flex",gap:10,justifyContent:"flex-end"},children:[e.jsx("button",{onClick:()=>B(null),style:{padding:"9px 18px",border:"1px solid #D1D5DB",borderRadius:8,cursor:"pointer"},children:"Cancelar"}),e.jsx("button",{onClick:T,disabled:S,style:{padding:"9px 18px",background:E,color:"#fff",border:"none",borderRadius:8,fontWeight:600,cursor:"pointer"},children:S?"Registrando...":"Registrar"})]})]})})]})]})}export{se as InventarioView};
