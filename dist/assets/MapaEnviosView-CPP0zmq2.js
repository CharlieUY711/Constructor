import{s as $,r as g,j as e,C as O,T as B,P as R,R as W}from"./index-Fw8Uzhwv.js";import{O as C}from"./OrangeHeader-Biphf6Xx.js";import{G as P}from"./GoogleMap-Bsx_Ba6G.js";import{N as y}from"./navigation-C06nlKGO.js";import{L as G}from"./loader-circle-DahKoUoD.js";import{C as N}from"./circle-check-pCdTZEBv.js";import"./zap-8sOeQZaC.js";import"./lightbulb-CE-CRi_D.js";import"./map-pin-BGWwb8Ew.js";import"./loader-CAj64nxW.js";async function V(h,x){let b=$.from("puntos_mapa").select("*");const{data:r,error:n}=await b.order("created_at",{ascending:!1});if(n)throw console.error("[mapaEnviosApi] Error obteniendo puntos del mapa:",n),new Error(n.message||"Error cargando puntos del mapa");return r||[]}const p="#FF6835",E={lat:-34.9011,lng:-56.1645},H=12,c={deposito:{color:"#374151",label:"Depósito",icon:R,size:18},en_transito:{color:"#7C3AED",label:"En tránsito",icon:B,size:14},en_reparto:{color:p,label:"En reparto",icon:y,size:14},entregado:{color:"#059669",label:"Entregado",icon:N,size:13},fallido:{color:"#DC2626",label:"Fallido",icon:O,size:14}};function te({onNavigate:h}){const[x,b]=g.useState("todos"),[r,n]=g.useState(null),[L,_]=g.useState([]),[I,k]=g.useState(!1),[S,w]=g.useState(null);g.useEffect(()=>{j()},[]);const j=async()=>{k(!0),w(null);try{const l=(await V()).map(t=>({id:t.id,tipo:t.tipo,numero:t.numero||"",lat:t.lat||(t.x?void 0:E.lat),lng:t.lng||(t.y?void 0:E.lng),x:t.x,y:t.y,cliente:t.cliente||"",carrier:t.carrier||"",localidad:t.localidad||"",provincia:t.provincia||""}));_(l)}catch(o){w(o instanceof Error?o.message:"Error cargando datos"),console.error("Error cargando mapa de envíos:",o)}finally{k(!1)}},s=L,a={en_transito:s.filter(o=>o.tipo==="en_transito").length,en_reparto:s.filter(o=>o.tipo==="en_reparto").length,entregado:s.filter(o=>o.tipo==="entregado").length,fallido:s.filter(o=>o.tipo==="fallido").length};return I?e.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsx(C,{icon:y,title:"Mapa de Envíos",subtitle:"Cargando...",actions:[{label:"← Logística",onClick:()=>h("logistica")}]}),e.jsx("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(G,{size:32,color:p,style:{animation:"spin 1s linear infinite"}})})]}):S?e.jsx("div",{style:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:e.jsx(C,{icon:y,title:"Mapa de Envíos",subtitle:`Error: ${S}`,actions:[{label:"← Logística",onClick:()=>h("logistica")},{label:"↻ Reintentar",primary:!0,onClick:j}]})}):e.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsx(C,{icon:y,title:"Mapa de Envíos",subtitle:`${a.en_transito} en tránsito · ${a.en_reparto} en reparto · ${a.entregado} entregados · ${a.fallido} fallidos`,actions:[{label:"← Logística",onClick:()=>h("logistica")},{label:"↻ Actualizar",onClick:j}]}),e.jsxs("div",{style:{flex:1,display:"flex",overflow:"hidden",backgroundColor:"#F8F9FA"},children:[e.jsxs("div",{style:{width:"260px",flexShrink:0,backgroundColor:"#fff",borderRight:"1px solid #E5E7EB",display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"14px 16px",borderBottom:"1px solid #E5E7EB"},children:[e.jsx("p",{style:{margin:"0 0 10px",fontSize:"11px",fontWeight:700,color:"#374151",textTransform:"uppercase",letterSpacing:"0.06em"},children:"Filtrar por estado"}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"6px"},children:[{id:"todos",label:"Todos los envíos",count:s.filter(o=>o.tipo!=="deposito").length},{id:"en_transito",label:"En tránsito",count:a.en_transito},{id:"en_reparto",label:"En reparto",count:a.en_reparto},{id:"entregado",label:"Entregados",count:a.entregado},{id:"fallido",label:"Fallidos",count:a.fallido}].map(o=>{const l=o.id!=="todos"?c[o.id]:{color:"#374151"},t=x===o.id;return e.jsxs("button",{onClick:()=>b(o.id),style:{display:"flex",alignItems:"center",gap:"8px",padding:"8px 10px",border:`1px solid ${t?l.color:"#E5E7EB"}`,borderRadius:"8px",backgroundColor:t?`${l.color}12`:"#fff",cursor:"pointer",transition:"all 0.15s"},children:[e.jsx("div",{style:{width:"10px",height:"10px",borderRadius:"50%",backgroundColor:l.color,flexShrink:0}}),e.jsx("span",{style:{fontSize:"12px",fontWeight:t?700:500,color:t?l.color:"#374151",flex:1,textAlign:"left"},children:o.label}),e.jsx("span",{style:{fontSize:"11px",fontWeight:700,color:"#6B7280",backgroundColor:"#F3F4F6",padding:"1px 6px",borderRadius:"8px"},children:o.count})]},o.id)})})]}),e.jsxs("div",{style:{padding:"14px 16px",borderBottom:"1px solid #E5E7EB"},children:[e.jsx("p",{style:{margin:"0 0 10px",fontSize:"11px",fontWeight:700,color:"#374151",textTransform:"uppercase",letterSpacing:"0.06em"},children:"Leyenda"}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"6px"},children:[Object.entries(c).filter(([o])=>o!=="deposito").map(([o,l])=>{const t=l.icon;return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("div",{style:{width:"20px",height:"20px",borderRadius:"50%",backgroundColor:l.color,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:e.jsx(t,{size:10,color:"#fff"})}),e.jsx("span",{style:{fontSize:"12px",color:"#374151"},children:l.label})]},o)}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("div",{style:{width:"20px",height:"20px",borderRadius:"50%",backgroundColor:"#374151",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:e.jsx(R,{size:10,color:"#fff"})}),e.jsx("span",{style:{fontSize:"12px",color:"#374151"},children:"Depósito / origen"})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginTop:"4px"},children:[e.jsx("div",{style:{width:"10px",height:"10px",borderRadius:"50%",backgroundColor:p,boxShadow:`0 0 0 4px ${p}30`,flexShrink:0,marginLeft:"5px"}}),e.jsx("span",{style:{fontSize:"11px",color:"#9CA3AF",marginLeft:"5px"},children:"Pulso = en reparto activo"})]})]})]}),e.jsx("div",{style:{flex:1,overflowY:"auto",padding:"8px 0"},children:s.filter(o=>o.tipo!=="deposito"&&(x==="todos"||o.tipo===x)).map(o=>{const l=c[o.tipo],t=(r==null?void 0:r.id)===o.id;return e.jsxs("div",{onClick:()=>n(t?null:o),style:{display:"flex",gap:"10px",alignItems:"center",padding:"10px 16px",cursor:"pointer",backgroundColor:t?"#FFF4EC":"transparent",borderLeft:t?`3px solid ${p}`:"3px solid transparent"},children:[e.jsx("div",{style:{width:"26px",height:"26px",borderRadius:"50%",backgroundColor:l.color,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:e.jsx(l.icon,{size:11,color:"#fff"})}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:"11px",fontWeight:700,color:"#111",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:o.numero}),e.jsxs("div",{style:{fontSize:"10px",color:"#9CA3AF"},children:[o.localidad," · ",o.carrier]})]})]},o.id)})})]}),e.jsxs("div",{style:{flex:1,position:"relative",overflow:"hidden"},children:[(()=>{const l=s.filter(i=>i.tipo!=="deposito"&&(x==="todos"||i.tipo===x)&&i.lat!==void 0&&i.lng!==void 0).map(i=>{const d=c[i.tipo];return{id:i.id,lat:i.lat,lng:i.lng,title:`${i.numero} - ${d.label}`,color:d.color,onClick:()=>n(i)}});s.filter(i=>i.tipo==="deposito"&&i.lat!==void 0&&i.lng!==void 0).forEach(i=>{l.push({id:i.id,lat:i.lat,lng:i.lng,title:`Depósito ${i.numero}`,color:"#374151",onClick:()=>n(i)})});let z=E,f=H;if(l.length>0){const i=l.map(v=>v.lat),d=l.map(v=>v.lng),u=Math.min(...i),F=Math.max(...i),D=Math.min(...d),A=Math.max(...d);z={lat:(u+F)/2,lng:(D+A)/2};const M=F-u,T=A-D,m=Math.max(M,T);m>.5?f=10:m>.2?f=11:m>.1?f=12:m>.05?f=13:f=14}return e.jsx(P,{center:z,zoom:f,markers:l,height:"100%",onMarkerClick:i=>{const d=s.find(u=>u.id===i.id);d&&n(d)}})})(),r&&r.tipo!=="deposito"&&e.jsxs("div",{style:{position:"absolute",bottom:"20px",right:"20px",backgroundColor:"#fff",borderRadius:"12px",border:"1px solid #E5E7EB",padding:"16px",width:"240px",boxShadow:"0 4px 20px rgba(0,0,0,0.12)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"10px"},children:[e.jsx("div",{style:{width:"28px",height:"28px",borderRadius:"50%",backgroundColor:c[r.tipo].color,display:"flex",alignItems:"center",justifyContent:"center"},children:W.createElement(c[r.tipo].icon,{size:13,color:"#fff"})}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"12px",fontWeight:700,color:"#111"},children:r.numero}),e.jsx("div",{style:{fontSize:"10px",color:"#9CA3AF"},children:c[r.tipo].label})]}),e.jsx("button",{onClick:()=>n(null),style:{marginLeft:"auto",border:"none",background:"none",cursor:"pointer",color:"#9CA3AF",fontSize:"16px",lineHeight:1},children:"×"})]}),[["Cliente",r.cliente],["Carrier",r.carrier],["Localidad",r.localidad],["Provincia",r.provincia]].map(([o,l])=>e.jsxs("div",{style:{display:"flex",gap:"8px",fontSize:"11px",marginBottom:"5px"},children:[e.jsx("span",{style:{color:"#9CA3AF",width:"65px",flexShrink:0},children:o}),e.jsx("span",{style:{color:"#111",fontWeight:500},children:l})]},o)),e.jsx("button",{onClick:()=>h("envios"),style:{marginTop:"10px",width:"100%",padding:"8px",border:`1.5px solid ${p}`,borderRadius:"8px",backgroundColor:"transparent",color:p,fontSize:"12px",fontWeight:700,cursor:"pointer"},children:"Ver detalle del envío →"})]}),e.jsx("div",{style:{position:"absolute",top:"16px",right:"16px",display:"flex",flexDirection:"column",gap:"6px"},children:Object.entries(a).map(([o,l])=>{if(l===0)return null;const t=c[o];return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"6px",backgroundColor:"rgba(255,255,255,0.92)",padding:"5px 10px",borderRadius:"20px",boxShadow:"0 2px 8px rgba(0,0,0,0.1)",border:`1px solid ${t.color}30`},children:[e.jsx("div",{style:{width:"8px",height:"8px",borderRadius:"50%",backgroundColor:t.color}}),e.jsx("span",{style:{fontSize:"11px",fontWeight:700,color:t.color},children:l}),e.jsx("span",{style:{fontSize:"11px",color:"#374151"},children:t.label})]},o)})})]})]})]})}export{te as MapaEnviosView};
